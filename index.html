<!DOCTYPE html>
<html>
  <head>
    <title>Real World Property Based Testing</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: Futura, 'Yanone Kaffeesatz';
      }
      li {
        font-size: 30px;
        padding-top: 20px;
      }
      .remark-code {
        font-size: 30px;
      }
      h1, h2, h3 {
        font-weight: normal;
      }
      .inverse {
        background: #4795c6;
        color: white;
      }
      .inverse h1, .inverse h2 {
        color: #f3f3f3;
        line-height: 0.8em;
      }
      .starwars {
        background: black;
        color: #07ffff;
      }
      .looper {
        background-image: url(images/looper2.jpg);
        background-size: 100%;
        background-color: #83a8ce;
        background-position: bottom;
        color: white;
      }
      .question {
        background: #76b242;
        color: white;
      }
      .rule {
        background: #ee2a24;
        color: white;
      }
      .image {
        padding: 0px;
        color: white;
        background-color: black;

        position: relative;
      }
      .image img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        /*height: 100%;*/
        float: left;
      }
      .image h1, .image h2 {
        position: absolute;
        bottom: 0;
        text-align: center;
        left: 20px;
      }
      .image-white {
        color: black;
        background-color: white;
      }
      .image-last h1 {
        right: 0;
        bottom: 100px;
      }
      .remark-code, .remark-inline-code {
        font-family: 'Ubuntu Mono';
      }
      .remark-slide-content {
        padding: 10px 10px 10px 30px;
      }
      .hljs-default .hljs {
        background-color: transparent;
      }
      .ambiata-full {
        background-image: url(http://ambiata.com/images/ambiata_avatar.png);
      }
      /*
      .ambiata-full h2 {
        position: absolute;
        bottom: 0;
        right: 0;
      }
      */
      .ambiata {
        background-image: url(http://ambiata.com/images/ambiata_avatar.png);
        background-position: top right;
        background-size: 100px;
        /*-webkit-filter: grayscale(40%);*/
      }
      .code-small .remark-code {
        font-size: 20px;
      }
    </style>
  </head>
  <body>

    <textarea id="source">
name: looper
layout: true
class: looper

---
name: image
layout: true
class: center, middle, image

---
name: image-white
layout: true
class: center, middle, image, image-white

---
name: image-last
layout: true
class: center, middle, image, image-last

---
name: ambiata
layout: true
class: ambiata

---
name: ambiata-full
layout: true
class: center, middle, ambiata-full

---
name: code-small
layout: true
class: code-small

---
name: question
layout: true
class: center, middle, question

---
name: rule
layout: true
class: center, middle, rule

---
name: inverse
layout: true
class: center, middle, inverse

---
name: starwars
layout: true
class: center, middle, starwars

---

class: center, middle
template: image

<img src="images/scala-good-parts.jpg" />

# Real World Property Based Testing

---

template: ambiata-full

# Ambiata












---

template: starwars

# A long time ago in a unit test far,
# far away

---
layout: false

## Once upon a time

```scala
val json = """
  { "name": "hello", "age": 10 }
  """

val user =
  User("hello", 10)

parseJson(json) == user
```

---

## Tedious

```scala
parseJson(read("example1.json")) == user1

parseJson(read("example2.json")) == user2

parseJson(read("example2.json")) == user2
```

---
template: image

<img src="images/manual-labour.jpg" />

# Manual labour

---
template: question

## There's gotta be a better way?

---

## Inverse

```scala
val user =
  User("foo", 10)

parseJson(toJson(user)) == user
```

---
template: question

## What if we could generate a User?

---

## Magic

```scala
forAll { user: User =>
  parseJson(toJson(user)) ?= user
}
```

---
template: image-white

<img src="images/property-inverse.png" style="margin-top: 150px" />

---
template: image

<img src="images/there-and-back-again1.jpg" />

# There and back again?

---
template: ambiata

## [Argonaut Codec Laws](https://github.com/ambiata/ivory/blob/master/ivory-core/src/test/scala/com/ambiata/ivory/core/ArgonautProperties.scala)

```scala
property("User json") =
  CodecJson.codecLaw.encodedecode[User]
```

---

template: image

<img src="images/there-and-back-again3.jpg" />

# There and back again!

---

## Hello World

```scala
forAll { s: String =>
  s.reverse.reverse ?= s
}
```

---

## Example - File Read/Write

```scala
forAll { a: User =>
  read(write(a)) ?= a.right
}
```

---

## Example - DB Read/Write

```scala
forAll { a: User =>
  get(create(a)) ?= a.right
}
```

---
template: image

<img src="images/golden-ticket.jpg" />











---

template: inverse

# Generators 101

---

## Step 1 - Data

```scala
case class User(name: String, age: Int)
```

---

## Step 2 - Just add Gen

```scala
object GenUser {

  def user: Gen[User] = for {
    name &lt;- arbitrary[String]
    age  &lt;- arbitrary[Int]
  } yield User(name, age)
}

def arbitrary[T: Arbitrary]: Gen[T] =
   ...
```

---

## Step 3 - Arbitrary

```scala
object Arbitraries {

  implicit def UserArbitrary: Arbitrary[User] =
    Arbitrary(GenUser.user)
}
```

---

## Step 4 - Profit

```scala
import Arbitraries._

forAll { (user: User) =>
  ...
}
```














---

template: inverse

# Laws

---

## Laws - Equal

```scala
import scalaz.scalacheck.ScalazProperties._

object equal {
  def laws[A: Equal : Arbitrary]: Properties = ...
}

property("user equal") = equal.laws[User]
```

---

## Laws - Order

```scala
import scalaz.scalacheck.ScalazProperties._

object equal {
  def laws[A: Equal : Arbitrary]: Properties = ...
}

property("user order") = order.laws[User]
```






---

template: inverse

# Multiple Paths

---
template: image-white

<img src="http://fsharpforfunandprofit.com/assets/img/property_commutative.png" style="margin-top: 120px;"/>

---

## TODO TODO 

```scala
forAll { l: List[Int] =>
  l.TODOTODO() == l
}
```

---

## Performance

```scala
def sortMutable[A](a: List[A]): List[A] = {
  val b = List.newBuilder[A](a.length)
  ...
  b.result()
}

prop { (a: List[Int]) =>
  sortMutable(a) ?= a.foldLeft(List[A])(_ :: _)
}
```

---

## Alternative

- TODO

```scala
prop { (a: List[Int]) =>
  sortMutable(a) ?= a.sorted
}
```

---

## Example in the wild

```scala
def dayMinus(d: Date, i: Int): Date = {
  ...
}

prop { (a: Date, i: Int) =>
  dayMinus(d, i) ?= JodaTime.minusDays(d.toJoda, i)
}
```













---

template: inverse

# Idempotence

---
layout: false

## Idempotence

```scala
prop { (a: String) =>
  a.distinct.distinct ?= a.distinct
}
```













---

template: inverse

# Invariants

---
layout: false

## Example

```scala
prop { (a: List[Int]) =>
  a.map(foo).size ?= a.size
}
```

---
## Real-world example

```scala
prop { (a: List[Int]) =>
 // TODO
}
```








---

template: inverse

# IO

---
layout: false

## DB

```scala
property("insert empty") = 
  forall { (e1: Entity) =>
    for {
      id &lt;- EntityDB.insert(e1)
      e2 &lt;- EntityDB.get(id)
    } yield e2 ?= Some(e1)
  }
```

---

## DB

```scala
property("insert non-empty") =
  forAll { (e1: Entity, e2: Entity) =>
    for {
      i1 &lt;- EntityDB.insert(e1)
      i2 &lt;- EntityDB.insert(e2)
      e3 &lt;- EntityDB.get(i2)
    } yield e3 ?= Some(e2)
  }
```

---
template: question

What happens if Entity.name has too be unique?

---
## DB

```scala
import com.ambiata.disorder.DistinctPair

property("insert non-empty unique") =
  forAll { (e1: Entity, e2a: Entity,
            names: DistinctPair[String]) =>
    for {
      i1 &lt;- EntityDB.insert(e1.copy(name = names.first))
      i2 &lt;- EntityDB.insert(e2.copy(name = names.second))
      e3 &lt;- i2.map(EntityDB.get)
        .getOrElse(DB.pure(Option.empty[Entity]))
    } yield
      e3 ?= Some(e2.copy(name = names.second))
  }
```

---
## DB

```scala
property("insert non-empty duplicate") =
  forAll { (e1: Entity, e2a: Entity, name: String) =>
    for {
      i1 &lt;- EntityDB.insert(e1.copy(name = name))
      i2 &lt;- EntityDB.insert(e2.copy(name = name))
    } yield (i1.isDefined, i2.isEmpty) ?= (true, true)
  }
```

---
template: ambiata

## [Disorder](https://github.com/ambiata/disorder/tree/master/src/main/scala/com/ambiata/disorder)

- DistinctList
- DistinctPair
- List10/List100/List1000
- NaturalInt
- NonEmptyString
- OrderPair
- etc...

---
template: question

<i>But is it too slow to run 100 times?</i>

---
layout: false

## Limit tests

```scala
prop { (input: Input) =>

  runHadoopOhGodItsSlow(input) ====
    input.groupBy(_.x).sortBy(_.y)

}.set(minTestsOk = 3)
```

---

## Not perfect but...

- Still better than hard-coded tests
- Can increase number locally
- Separate build with different sizes
- Need to think harder about your code!








---

template: inverse

# Arbitrary skillz

---
layout: false

- Composable/re-usable
- TODO

---

## Domain Objects

```scala
TODO
```

---

template: image

<img src="images/dividends.jpg" height="100%" />














---

template: inverse

# TDD

---

template: inverse

# Type Driven Development

---

- TODO 











---

# Data (Un)zipper
- TODO NAME
 - peek?


---

## Simple Example

```scala
class List[A] {
  def headOption: Option[A]
}
```

---

## When you first start

```scala
forAll { (a: List[Int]) =>
  a.headOption ?= (if (a.isEmpty) None else a.head)
}
```

---
template: question

<i>Isn't that just the implementation?!?</i>

---

template: image-white

<img src="images/pulling-hair-out.jpg" />

---

## Take 2 - Ignore inputs

```scala
forAll { (l: List[Int]) => !l.isEmpty ==> {
  l.headOption ?= Some(l.head)
}}
```

---

## Beware...

```scala
forAll { l: List[Int] => l.isEmpty ==> {
  true
}}
```

---

template: rule

<i>Gave up after only 5 passed tests. 96 tests were discarded.</i>

---

## NonEmptyList

```scala
forAll { (h: Int, t: List[Int]) =>
  (h :: t).headOption ?= Some(h)
}
```

---

## Scalaz NonEmptyList

```scala
import scalaz._
import scalaz.scalacheck.ScalazArbitrary._

case class NonEmptyList(head: A, tail: List[A]) {
  
  def list: List[A] =
    a :: tail
}

forAll { l: NonEmptyList[Int] =>
   l.list.headOption ?= Some(a.head)
}
```












---

template: inverse

# Frequency

---

## Naive

```scala
def genInt: Gen[Int] =
  Gen.choose(Int.MinValue, Int.MaxValue)
```

---

## More Frequent

```scala
def genInt: Gen[Int] =
  Gen.frequency(
    20 -> 0,
    20 -> Int.MaxValue,
    20 -> Int.MinValue,
    10 -> 1,
    10 -> -1,
    5  -> Gen.choose(Int.MinValue, Int.MaxValue)
  )
```

---

## Re-usable

- TODO SHOW OUTPUT WITH DIFFERENT FAILURE RATES (OR SOMETHING)

```scala
prop { (a: Int, b: Int) =>
  a + b must beGreaterThan(a)
}
```









---
template: inverse

## This has nothing to do with Scala

---
template: inverse

## It even works for Java!

---

## Java

```java
@Theory public void testTruncate(
  @ForAll String input,
  @ForAll int length) {

  assertEquals(StringUtils.truncate(input, length), "");
}
```

---
template: inverse

## It even works for Javascript!!!

---

## Javascript

```js
check.it('Can handle negative lengths',

  [gen.alphaNumString, gen.int],
  function(input, length) {

  StringUtils.truncate(input, length).should.equal('') 
})
```

---
template: image

<img src="images/everywhere2.jpg" height="120%" style="margin-top: -60px" />

---
template: image

<img src="images/changed-my-life.jpg" height="100%" />

---
layout: false

# Links

- John Hughes - "Testing the Hard Stuff and Staying Sane"
  - https://www.youtube.com/watch?v=zi0rHwfiX1Q
- Jessica Kerr - "Property-Based Testing for Better Code"
  - https://www.youtube.com/watch?v=shngiiBfD80
- "Choosing properties for property-based testing"
  - http://fsharpforfunandprofit.com/posts/property-based-testing-2/


    </textarea>
    <script src="http://gnab.github.io/remark/downloads/remark-latest.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>.
